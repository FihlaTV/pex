<!DOCTYPE html>

<html>
<head>
  <title>PerspectiveCamera.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>PerspectiveCamera.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Generated by CoffeeScript 1.7.1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Mat4, PerspectiveCamera, Ray, Vec2, Vec3, Vec4, _ref;

_ref = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pex-geom'</span>), Vec2 = _ref.Vec2, Vec3 = _ref.Vec3, Vec4 = _ref.Vec4, Mat4 = _ref.Mat4, Ray = _ref.Ray;

PerspectiveCamera = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> projected;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PerspectiveCamera</span><span class="hljs-params">(fov, aspectRatio, near, far, position, target, up)</span> </span>{
    <span class="hljs-keyword">this</span>.fov = fov || <span class="hljs-number">60</span>;
    <span class="hljs-keyword">this</span>.aspectRatio = aspectRatio || <span class="hljs-number">4</span> / <span class="hljs-number">3</span>;
    <span class="hljs-keyword">this</span>.near = near || <span class="hljs-number">0.1</span>;
    <span class="hljs-keyword">this</span>.far = far || <span class="hljs-number">100</span>;
    <span class="hljs-keyword">this</span>.position = position || Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
    <span class="hljs-keyword">this</span>.target = target || Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>.up = up || Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>.projectionMatrix = Mat4.create();
    <span class="hljs-keyword">this</span>.viewMatrix = Mat4.create();
    <span class="hljs-keyword">this</span>.updateMatrices();
  }

  PerspectiveCamera.prototype.getFov = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fov;
  };

  PerspectiveCamera.prototype.getAspectRatio = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.aspectRatio;
  };

  PerspectiveCamera.prototype.getNear = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.near;
  };

  PerspectiveCamera.prototype.getFar = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.far;
  };

  PerspectiveCamera.prototype.getPosition = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.position;
  };

  PerspectiveCamera.prototype.getTarget = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.target;
  };

  PerspectiveCamera.prototype.getUp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.up;
  };

  PerspectiveCamera.prototype.getViewMatrix = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.viewMatrix;
  };

  PerspectiveCamera.prototype.getProjectionMatrix = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.projectionMatrix;
  };

  PerspectiveCamera.prototype.setFov = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fov)</span> </span>{
    <span class="hljs-keyword">this</span>.fov = fov;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateMatrices();
  };

  PerspectiveCamera.prototype.setAspectRatio = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ratio)</span> </span>{
    <span class="hljs-keyword">this</span>.aspectRatio = ratio;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateMatrices();
  };

  PerspectiveCamera.prototype.setFar = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(far)</span> </span>{
    <span class="hljs-keyword">this</span>.far = far;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateMatrices();
  };

  PerspectiveCamera.prototype.setNear = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(near)</span> </span>{
    <span class="hljs-keyword">this</span>.near = near;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateMatrices();
  };

  PerspectiveCamera.prototype.setPosition = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(position)</span> </span>{
    <span class="hljs-keyword">this</span>.position = position;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateMatrices();
  };

  PerspectiveCamera.prototype.setTarget = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target)</span> </span>{
    <span class="hljs-keyword">this</span>.target = target;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateMatrices();
  };

  PerspectiveCamera.prototype.setUp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(up)</span> </span>{
    <span class="hljs-keyword">this</span>.up = up;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateMatrices();
  };

  PerspectiveCamera.prototype.lookAt = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target, eyePosition, up)</span> </span>{
    <span class="hljs-keyword">if</span> (target) {
      <span class="hljs-keyword">this</span>.target = target;
    }
    <span class="hljs-keyword">if</span> (eyePosition) {
      <span class="hljs-keyword">this</span>.position = eyePosition;
    }
    <span class="hljs-keyword">if</span> (up) {
      <span class="hljs-keyword">this</span>.up = up;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateMatrices();
  };

  PerspectiveCamera.prototype.updateMatrices = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.projectionMatrix.identity().perspective(<span class="hljs-keyword">this</span>.fov, <span class="hljs-keyword">this</span>.aspectRatio, <span class="hljs-keyword">this</span>.near, <span class="hljs-keyword">this</span>.far);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.viewMatrix.identity().lookAt(<span class="hljs-keyword">this</span>.position, <span class="hljs-keyword">this</span>.target, <span class="hljs-keyword">this</span>.up);
  };

  projected = Vec4.create();

  PerspectiveCamera.prototype.getScreenPos = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(point, windowWidth, windowHeight)</span> </span>{
    <span class="hljs-keyword">var</span> out;
    projected.set(point.x, point.y, point.z, <span class="hljs-number">1.0</span>);
    projected.transformMat4(<span class="hljs-keyword">this</span>.viewMatrix);
    projected.transformMat4(<span class="hljs-keyword">this</span>.projectionMatrix);
    out = Vec2.create().set(projected.x, projected.y);
    out.x /= projected.w;
    out.y /= projected.w;
    out.x = out.x * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>;
    out.y = out.y * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>;
    out.x *= windowWidth;
    out.y *= windowHeight;
    <span class="hljs-keyword">return</span> out;
  };

  PerspectiveCamera.prototype.getViewRay = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, windowWidth, windowHeight)</span> </span>{
    <span class="hljs-keyword">var</span> hNear, px, py, vDirection, vOrigin, vTarget, wNear;
    px = (x - windowWidth / <span class="hljs-number">2</span>) / (windowWidth / <span class="hljs-number">2</span>);
    py = -(y - windowHeight / <span class="hljs-number">2</span>) / (windowHeight / <span class="hljs-number">2</span>);
    hNear = <span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.tan(<span class="hljs-keyword">this</span>.getFov() / <span class="hljs-number">180</span> * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>) * <span class="hljs-keyword">this</span>.getNear();
    wNear = hNear * <span class="hljs-keyword">this</span>.getAspectRatio();
    px *= wNear / <span class="hljs-number">2</span>;
    py *= hNear / <span class="hljs-number">2</span>;
    vOrigin = <span class="hljs-keyword">new</span> Vec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    vTarget = <span class="hljs-keyword">new</span> Vec3(px, py, -<span class="hljs-keyword">this</span>.getNear());
    vDirection = vTarget.dup().sub(vOrigin).normalize();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Ray(vOrigin, vDirection);
  };

  PerspectiveCamera.prototype.getWorldRay = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, windowWidth, windowHeight)</span> </span>{
    <span class="hljs-keyword">var</span> hNear, invViewMatrix, vOrigin, vTarget, wDirection, wNear, wOrigin, wTarget;
    x = (x - windowWidth / <span class="hljs-number">2</span>) / (windowWidth / <span class="hljs-number">2</span>);
    y = -(y - windowHeight / <span class="hljs-number">2</span>) / (windowHeight / <span class="hljs-number">2</span>);
    hNear = <span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.tan(<span class="hljs-keyword">this</span>.getFov() / <span class="hljs-number">180</span> * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>) * <span class="hljs-keyword">this</span>.getNear();
    wNear = hNear * <span class="hljs-keyword">this</span>.getAspectRatio();
    x *= wNear / <span class="hljs-number">2</span>;
    y *= hNear / <span class="hljs-number">2</span>;
    vOrigin = <span class="hljs-keyword">new</span> Vec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    vTarget = <span class="hljs-keyword">new</span> Vec3(x, y, -<span class="hljs-keyword">this</span>.getNear());
    invViewMatrix = <span class="hljs-keyword">this</span>.getViewMatrix().dup().invert();
    wOrigin = vOrigin.dup().transformMat4(invViewMatrix);
    wTarget = vTarget.dup().transformMat4(invViewMatrix);
    wDirection = wTarget.dup().sub(wOrigin);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Ray(wOrigin, wDirection);
  };

  <span class="hljs-keyword">return</span> PerspectiveCamera;

})();

<span class="hljs-built_in">module</span>.exports = PerspectiveCamera;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

<!DOCTYPE html>

<html>
<head>
  <title>Texture2D.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Texture2D.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> sys = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pex-sys'</span>);
<span class="hljs-keyword">var</span> merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'merge'</span>);
<span class="hljs-keyword">var</span> IO = sys.IO;
<span class="hljs-keyword">var</span> Context = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Context'</span>);
<span class="hljs-keyword">var</span> Texture = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Texture'</span>);
<span class="hljs-keyword">var</span> Platform = sys.Platform;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Texture2D</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.gl = Context.currentContext;
  Texture.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.gl.TEXTURE_2D);
}

Texture2D.prototype = <span class="hljs-built_in">Object</span>.create(Texture.prototype);

Texture2D.create = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, h, options)</span> </span>{
  <span class="hljs-keyword">var</span> gl = Context.currentContext;

  <span class="hljs-keyword">var</span> defaultOptions = {
    repeat: <span class="hljs-literal">false</span>,
    mipmap: <span class="hljs-literal">false</span>,
    nearest: <span class="hljs-literal">false</span>,
    internalFormat: gl.RGBA,
    format: gl.RGBA,
    type: gl.UNSIGNED_BYTE
  };
  options = merge(defaultOptions, options);
  options.internalFormat = options.format;

  <span class="hljs-keyword">if</span> (options.bpp == <span class="hljs-number">32</span>) {
    options.type = gl.FLOAT;
  }

  <span class="hljs-keyword">var</span> texture = <span class="hljs-keyword">new</span> Texture2D();
  texture.bind();

  texture.checkExtensions(options);

  gl.texImage2D(gl.TEXTURE_2D, <span class="hljs-number">0</span>, options.internalFormat, w, h, <span class="hljs-number">0</span>, options.format, options.type, <span class="hljs-literal">null</span>);

  <span class="hljs-keyword">var</span> wrapS = options.repeat ? gl.REPEAT : gl.CLAMP_TO_EDGE;
  <span class="hljs-keyword">var</span> wrapT = options.repeat ? gl.REPEAT : gl.CLAMP_TO_EDGE;
  <span class="hljs-keyword">var</span> magFilter = gl.LINEAR;
  <span class="hljs-keyword">var</span> minFilter = gl.LINEAR;

  <span class="hljs-keyword">if</span> (options.nearest) {
    magFilter = gl.NEAREST;
    minFilter = gl.NEAREST;
  }

  <span class="hljs-keyword">if</span> (options.mipmap) {
    minFilter = gl.LINEAR_MIPMAP_LINEAR;
  }

  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, magFilter);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, minFilter);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, wrapS);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, wrapT);
  gl.bindTexture(gl.TEXTURE_2D, <span class="hljs-literal">null</span>);

  texture.width = w;
  texture.height = h;
  texture.target = gl.TEXTURE_2D;
  <span class="hljs-keyword">return</span> texture;
};

Texture2D.prototype.checkExtensions = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
  <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.gl;
  <span class="hljs-keyword">if</span> (Platform.isBrowser) {
    <span class="hljs-keyword">if</span> (options.format == gl.DEPTH_COMPONENT) {
      <span class="hljs-keyword">var</span> depthTextureExt = gl.getExtension(<span class="hljs-string">'WEBGL_depth_texture'</span>);
      <span class="hljs-keyword">if</span> (!depthTextureExt) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'Texture2D creating texture with format:gl.DEPTH_COMPONENT but WEBGL_depth_texture is not available'</span>;
      }
    }
    <span class="hljs-keyword">if</span> (options.type == gl.FLOAT) {
      <span class="hljs-keyword">if</span> (Platform.isMobile) {
        <span class="hljs-keyword">var</span> textureHalfFloatExt = gl.getExtension(<span class="hljs-string">'OES_texture_half_float'</span>);
        <span class="hljs-keyword">if</span> (!textureHalfFloatExt) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Texture2D creating texture with type:gl.FLOAT but OES_texture_half_float is not available'</span>;
        }
        <span class="hljs-keyword">var</span> textureHalfFloatLinerExt = gl.getExtension(<span class="hljs-string">'OES_texture_half_float_linear'</span>);
        <span class="hljs-keyword">if</span> (!textureHalfFloatLinerExt) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Texture2D creating texture with type:gl.FLOAT but OES_texture_half_float_linear is not available'</span>;
        }
        options.type = textureHalfFloatExt.HALF_FLOAT_OES;
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> textureFloatExt = gl.getExtension(<span class="hljs-string">'OES_texture_float'</span>);
        <span class="hljs-keyword">if</span> (!textureFloatExt) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Texture2D creating texture with type:gl.FLOAT but OES_texture_float is not available'</span>;
        }
        <span class="hljs-keyword">var</span> textureFloatLinerExt = gl.getExtension(<span class="hljs-string">'OES_texture_float_linear'</span>);
        <span class="hljs-keyword">if</span> (!textureFloatLinerExt) {
          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Texture2D creating texture with type:gl.FLOAT but OES_texture_float_linear is not available'</span>;
        }
      }
    }
  }
}

Texture2D.prototype.bind = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(unit)</span> </span>{
  unit = unit ? unit : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">this</span>.gl.activeTexture(<span class="hljs-keyword">this</span>.gl.TEXTURE0 + unit);
  <span class="hljs-keyword">this</span>.gl.bindTexture(<span class="hljs-keyword">this</span>.gl.TEXTURE_2D, <span class="hljs-keyword">this</span>.handle);
};

Texture2D.genNoise = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, h)</span> </span>{
  w = w || <span class="hljs-number">256</span>;
  h = h || <span class="hljs-number">256</span>;
  <span class="hljs-keyword">var</span> gl = Context.currentContext;
  <span class="hljs-keyword">var</span> texture = <span class="hljs-keyword">new</span> Texture2D();
  texture.bind();</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO: should check unpack alignment as explained here <a href="https://groups.google.com/forum/#!topic/webgl-dev-list/wuUZP7iTr9Q">https://groups.google.com/forum/#!topic/webgl-dev-list/wuUZP7iTr9Q</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> b = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(w * h * <span class="hljs-number">2</span>);
  <span class="hljs-keyword">var</span> pixels = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(b);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; h; y++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; w; x++) {
      pixels[y * w + x] = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">255</span>);
    }
  }
  gl.texImage2D(gl.TEXTURE_2D, <span class="hljs-number">0</span>, gl.LUMINANCE, w, h, <span class="hljs-number">0</span>, gl.LUMINANCE, gl.UNSIGNED_BYTE, pixels);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
  gl.bindTexture(gl.TEXTURE_2D, <span class="hljs-literal">null</span>);
  texture.width = w;
  texture.height = h;
  <span class="hljs-keyword">return</span> texture;
};

Texture2D.genNoiseRGBA = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, h)</span> </span>{
  w = w || <span class="hljs-number">256</span>;
  h = h || <span class="hljs-number">256</span>;
  <span class="hljs-keyword">var</span> gl = Context.currentContext;
  <span class="hljs-keyword">var</span> handle = gl.createTexture();
  gl.activeTexture(gl.TEXTURE0);
  gl.bindTexture(gl.TEXTURE_2D, handle);
  <span class="hljs-keyword">var</span> b = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(w * h * <span class="hljs-number">4</span>);
  <span class="hljs-keyword">var</span> pixels = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(b);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; h; y++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; w; x++) {
      pixels[(y * w + x) * <span class="hljs-number">4</span> + <span class="hljs-number">0</span>] = y;
      pixels[(y * w + x) * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>] = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">255</span> * <span class="hljs-built_in">Math</span>.random());
      pixels[(y * w + x) * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>] = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">255</span> * <span class="hljs-built_in">Math</span>.random());
      pixels[(y * w + x) * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>] = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">255</span> * <span class="hljs-built_in">Math</span>.random());
    }
  }
  gl.texImage2D(gl.TEXTURE_2D, <span class="hljs-number">0</span>, gl.RGBA, w, h, <span class="hljs-number">0</span>, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
  gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, <span class="hljs-literal">true</span>);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
  gl.bindTexture(gl.TEXTURE_2D, <span class="hljs-literal">null</span>);
  <span class="hljs-keyword">var</span> texture = <span class="hljs-keyword">new</span> Texture2D();
  texture.handle = handle;
  texture.width = w;
  texture.height = h;
  texture.target = gl.TEXTURE_2D;
  texture.gl = gl;
  <span class="hljs-keyword">return</span> texture;
};

Texture2D.load = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(src, options, callback)</span> </span>{
  <span class="hljs-keyword">if</span> (!callback &amp;&amp; <span class="hljs-keyword">typeof</span>(options) == <span class="hljs-string">'function'</span>) {
    callback = options;
    options = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">var</span> defaultOptions = {
    repeat: <span class="hljs-literal">false</span>,
    mipmap: <span class="hljs-literal">false</span>,
    nearest: <span class="hljs-literal">false</span>,
    flip: <span class="hljs-literal">true</span>
  };
  options = merge(defaultOptions, options);

  <span class="hljs-keyword">var</span> gl = Context.currentContext;
  <span class="hljs-keyword">var</span> texture = Texture2D.create(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, options);
  texture.ready = <span class="hljs-literal">false</span>;
  IO.loadImageData(gl, texture.handle, texture.target, texture.target, src, { flip: options.flip, crossOrigin: options.crossOrigin }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(image)</span> </span>{
    <span class="hljs-keyword">if</span> (!image) {
      texture.dispose();
      <span class="hljs-keyword">var</span> noise = Texture2D.getNoise();
      texture.handle = noise.handle;
      texture.width = noise.width;
      texture.height = noise.height;
    }
    <span class="hljs-keyword">if</span> (options.mipmap) {
      texture.generateMipmap();
    }
    gl.bindTexture(texture.target, <span class="hljs-literal">null</span>);
    texture.width = image.width;
    texture.height = image.height;
    texture.ready = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (callback) {
      callback(texture);
    }
  });
  <span class="hljs-keyword">return</span> texture;
};

Texture2D.prototype.dispose = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.handle) {
    <span class="hljs-keyword">this</span>.gl.deleteTexture(<span class="hljs-keyword">this</span>.handle);
    <span class="hljs-keyword">this</span>.handle = <span class="hljs-literal">null</span>;
  }
};

Texture2D.prototype.generateMipmap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.gl.bindTexture(<span class="hljs-keyword">this</span>.gl.TEXTURE_2D, <span class="hljs-keyword">this</span>.handle);
  <span class="hljs-keyword">this</span>.gl.generateMipmap(<span class="hljs-keyword">this</span>.gl.TEXTURE_2D);
}

<span class="hljs-built_in">module</span>.exports = Texture2D;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

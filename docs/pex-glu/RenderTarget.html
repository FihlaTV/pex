<!DOCTYPE html>

<html>
<head>
  <title>RenderTarget.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>RenderTarget.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Context = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Context'</span>);
<span class="hljs-keyword">var</span> Texture2D = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Texture2D'</span>);
<span class="hljs-keyword">var</span> merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'merge'</span>);
<span class="hljs-keyword">var</span> sys = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pex-sys'</span>);
<span class="hljs-keyword">var</span> Platform = sys.Platform;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RenderTarget</span><span class="hljs-params">(width, height, options)</span> </span>{
  <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.gl = Context.currentContext;

  <span class="hljs-keyword">var</span> defaultOptions = {
    color: <span class="hljs-literal">true</span>,
    depth: <span class="hljs-literal">false</span>
  };
  options = merge(defaultOptions, options);

  <span class="hljs-keyword">this</span>.width = width;
  <span class="hljs-keyword">this</span>.height = height;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>save current state to recover after we are done</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.oldBinding = gl.getParameter(gl.FRAMEBUFFER_BINDING);

  <span class="hljs-keyword">this</span>.handle = gl.createFramebuffer();
  gl.bindFramebuffer(gl.FRAMEBUFFER, <span class="hljs-keyword">this</span>.handle);

  <span class="hljs-keyword">this</span>.colorAttachments = [];
  <span class="hljs-keyword">this</span>.colorAttachmentsPositions = [];
  <span class="hljs-keyword">this</span>.depthAttachments = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>color buffer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">if</span> (options.color === <span class="hljs-literal">true</span>) { <span class="hljs-comment">//make our own</span>
    <span class="hljs-keyword">var</span> texture = Texture2D.create(width, height, options);
    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, texture.target, texture.handle, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>.colorAttachments.push(texture);
    <span class="hljs-keyword">this</span>.colorAttachmentsPositions.push(gl.COLOR_ATTACHMENT0);
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.color.length !== <span class="hljs-literal">undefined</span> &amp;&amp; options.color.length &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">//use supplied textures for MRT</span>
    options.color.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(colorBuf, colorBufIndex)</span> </span>{
      gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0 + colorBufIndex, colorBuf.target, colorBuf.handle, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">this</span>.colorAttachments.push(colorBuf);
      <span class="hljs-keyword">this</span>.colorAttachmentsPositions.push(gl.COLOR_ATTACHMENT0 + colorBufIndex);
    }.bind(<span class="hljs-keyword">this</span>));
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.color !== <span class="hljs-literal">false</span>) { <span class="hljs-comment">//use supplied texture</span>
    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, options.color.target, options.color.handle, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>.colorAttachments.push(options.color);
    <span class="hljs-keyword">this</span>.colorAttachmentsPositions.push(gl.COLOR_ATTACHMENT0);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>depth buffer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">if</span> (options.depth) {
    <span class="hljs-keyword">if</span> (options.depth === <span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">var</span> oldRenderBufferBinding = gl.getParameter(gl.RENDERBUFFER_BINDING);

      <span class="hljs-keyword">this</span>.depthAttachments[<span class="hljs-number">0</span>] = { handle:  gl.createRenderbuffer() };
      gl.bindRenderbuffer(gl.RENDERBUFFER, <span class="hljs-keyword">this</span>.depthAttachments[<span class="hljs-number">0</span>].handle);
      gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, <span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height);
      gl.bindRenderbuffer(gl.RENDERBUFFER, oldRenderBufferBinding);
      gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, <span class="hljs-keyword">this</span>.depthAttachments[<span class="hljs-number">0</span>].handle);
    }
    <span class="hljs-keyword">else</span> { <span class="hljs-comment">//use supplied depth texture</span>
      <span class="hljs-keyword">this</span>.depthAttachments[<span class="hljs-number">0</span>] = options.depth;
      gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.TEXTURE_2D, <span class="hljs-keyword">this</span>.depthAttachments[<span class="hljs-number">0</span>].handle, <span class="hljs-number">0</span>);
    }
  }

  <span class="hljs-keyword">this</span>.checkFramebuffer();
  <span class="hljs-keyword">this</span>.checkExtensions();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>revert to old framebuffer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  gl.bindFramebuffer(gl.FRAMEBUFFER, <span class="hljs-keyword">this</span>.oldBinding);
  <span class="hljs-keyword">this</span>.oldBinding = <span class="hljs-literal">null</span>;
}

RenderTarget.prototype.checkExtensions = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.gl;
  <span class="hljs-keyword">if</span> (Platform.isBrowser) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.colorAttachments.length &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.webglDrawBuffersExt = gl.getExtension(<span class="hljs-string">'WEBGL_draw_buffers'</span>);
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.webglDrawBuffersExt) {
        <span class="hljs-keyword">throw</span> <span class="hljs-string">'RenderTarget creating multiple render targets:'</span> + <span class="hljs-keyword">this</span>.colorAttachments.length + <span class="hljs-string">' but WEBGL_draw_buffers is not available'</span>;
      }
    }
  }
}

RenderTarget.prototype.bind = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.gl;
  <span class="hljs-keyword">this</span>.oldBinding = gl.getParameter(gl.FRAMEBUFFER_BINDING);

  gl.bindFramebuffer(gl.FRAMEBUFFER, <span class="hljs-keyword">this</span>.handle);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.colorAttachmentsPositions.length &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (Platform.isBrowser) {
      <span class="hljs-keyword">this</span>.webglDrawBuffersExt.drawBuffersWEBGL(<span class="hljs-keyword">this</span>.colorAttachmentsPositions);
    }
    <span class="hljs-keyword">else</span> {
     gl.drawBuffers(<span class="hljs-keyword">this</span>.colorAttachmentsPositions);
    }
  }
};

RenderTarget.prototype.bindAndClear = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.gl;
  <span class="hljs-keyword">this</span>.bind();

  gl.clearColor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.depthAttachments.length &gt; <span class="hljs-number">0</span>) {
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
  }
  <span class="hljs-keyword">else</span> {
    gl.clear(gl.COLOR_BUFFER_BIT);
  }
};

RenderTarget.prototype.unbind = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.gl;
  gl.bindFramebuffer(gl.FRAMEBUFFER, <span class="hljs-keyword">this</span>.oldBinding);
  <span class="hljs-keyword">this</span>.oldBinding = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.colorAttachmentsPositions.length &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">if</span> (Platform.isBrowser) {
      <span class="hljs-keyword">this</span>.webglDrawBuffersExt.drawBuffersWEBGL([gl.COLOR_ATTACHMENT0]);
    }
    <span class="hljs-keyword">else</span> {
     gl.drawBuffers([gl.COLOR_ATTACHMENT0]);
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>assumes that the framebuffer is bound</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>RenderTarget.prototype.checkFramebuffer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.gl;
  <span class="hljs-keyword">var</span> valid = gl.checkFramebufferStatus(gl.FRAMEBUFFER);
  <span class="hljs-keyword">switch</span>(valid) {
    <span class="hljs-keyword">case</span> gl.FRAMEBUFFER_UNSUPPORTED:                    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Framebuffer is unsupported'</span>;
    <span class="hljs-keyword">case</span> gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Framebuffer incomplete attachment'</span>;
    <span class="hljs-keyword">case</span> gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:          <span class="hljs-keyword">throw</span> <span class="hljs-string">'Framebuffer incomplete dimensions'</span>;
    <span class="hljs-keyword">case</span> gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:  <span class="hljs-keyword">throw</span> <span class="hljs-string">'Framebuffer incomplete missing attachment'</span>;
  }
}

RenderTarget.prototype.getColorAttachment = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> </span>{
  index = index || <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.colorAttachments[index];
};

RenderTarget.prototype.getDepthAttachement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.depthAttachments[<span class="hljs-number">0</span>];
}

 <span class="hljs-built_in">module</span>.exports = RenderTarget;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

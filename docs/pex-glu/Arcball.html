<!DOCTYPE html>

<html>
<head>
  <title>Arcball.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Arcball.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Generated by CoffeeScript 1.7.1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Arcball, Mat4, Plane, Quat, Vec2, Vec3, Vec4, _ref;

_ref = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pex-geom'</span>), Vec2 = _ref.Vec2, Vec3 = _ref.Vec3, Vec4 = _ref.Vec4, Quat = _ref.Quat, Mat4 = _ref.Mat4, Plane = _ref.Plane;

Arcball = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Arcball</span><span class="hljs-params">(window, camera, distance)</span> </span>{
    <span class="hljs-keyword">this</span>.camera = camera;
    <span class="hljs-keyword">this</span>.window = <span class="hljs-built_in">window</span>;
    <span class="hljs-keyword">this</span>.radius = <span class="hljs-built_in">Math</span>.min(<span class="hljs-built_in">window</span>.width / <span class="hljs-number">2</span>, <span class="hljs-built_in">window</span>.height / <span class="hljs-number">2</span>) * <span class="hljs-number">2</span>;
    <span class="hljs-keyword">this</span>.center = Vec2.create(<span class="hljs-built_in">window</span>.width / <span class="hljs-number">2</span>, <span class="hljs-built_in">window</span>.height / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">this</span>.currRot = Quat.create();
    <span class="hljs-keyword">this</span>.currRot.setAxisAngle(Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>), <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>.clickRot = Quat.create();
    <span class="hljs-keyword">this</span>.dragRot = Quat.create();
    <span class="hljs-keyword">this</span>.clickPos = Vec3.create();
    <span class="hljs-keyword">this</span>.clickPosWindow = Vec2.create();
    <span class="hljs-keyword">this</span>.dragPos = Vec3.create();
    <span class="hljs-keyword">this</span>.dragPosWindow = Vec2.create();
    <span class="hljs-keyword">this</span>.rotAxis = Vec3.create();
    <span class="hljs-keyword">this</span>.allowZooming = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.enabled = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.clickTarget = Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>.setDistance(distance || <span class="hljs-number">2</span>);
    <span class="hljs-keyword">this</span>.updateCamera();
    <span class="hljs-keyword">this</span>.addEventHanlders();
  }

  Arcball.prototype.setTarget = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target)</span> </span>{
    <span class="hljs-keyword">this</span>.camera.setTarget(target);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateCamera();
  };

  Arcball.prototype.setOrientation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dir)</span> </span>{
    <span class="hljs-keyword">this</span>.currRot.setDirection(dir);
    <span class="hljs-keyword">this</span>.currRot.w *= -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.updateCamera();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };

  Arcball.prototype.setPosition = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pos)</span> </span>{
    <span class="hljs-keyword">var</span> dir;
    dir = Vec3.create().asSub(pos, <span class="hljs-keyword">this</span>.camera.getTarget());
    <span class="hljs-keyword">this</span>.setOrientation(dir.dup().normalize());
    <span class="hljs-keyword">this</span>.setDistance(dir.length());
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateCamera();
  };

  Arcball.prototype.addEventHanlders = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.window.on(<span class="hljs-string">'leftMouseDown'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_this)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">if</span> (e.handled || !_this.enabled) {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">return</span> _this.down(e.x, e.y, e.shift);
      };
    })(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.window.on(<span class="hljs-string">'leftMouseUp'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_this)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">return</span> _this.up(e.x, e.y, e.shift);
      };
    })(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.window.on(<span class="hljs-string">'mouseDragged'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_this)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">if</span> (e.handled || !_this.enabled) {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">return</span> _this.drag(e.x, e.y, e.shift);
      };
    })(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.window.on(<span class="hljs-string">'scrollWheel'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_this)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">if</span> (e.handled || !_this.enabled) {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (!_this.allowZooming) {
          <span class="hljs-keyword">return</span>;
        }
        _this.distance = <span class="hljs-built_in">Math</span>.min(_this.maxDistance, <span class="hljs-built_in">Math</span>.max(_this.distance + e.dy / <span class="hljs-number">100</span> * (_this.maxDistance - _this.minDistance), _this.minDistance));
        <span class="hljs-keyword">return</span> _this.updateCamera();
      };
    })(<span class="hljs-keyword">this</span>));
  };

  Arcball.prototype.mouseToSphere = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y)</span> </span>{
    <span class="hljs-keyword">var</span> dist, v;
    y = <span class="hljs-keyword">this</span>.window.height - y;
    v = Vec3.create((x - <span class="hljs-keyword">this</span>.center.x) / <span class="hljs-keyword">this</span>.radius, (y - <span class="hljs-keyword">this</span>.center.y) / <span class="hljs-keyword">this</span>.radius, <span class="hljs-number">0</span>);
    dist = v.x * v.x + v.y * v.y;
    <span class="hljs-keyword">if</span> (dist &gt; <span class="hljs-number">1</span>) {
      v.normalize();
    } <span class="hljs-keyword">else</span> {
      v.z = <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">1.0</span> - dist);
    }
    <span class="hljs-keyword">return</span> v;
  };

  Arcball.prototype.down = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, shift)</span> </span>{
    <span class="hljs-keyword">var</span> target, targetInViewSpace;
    <span class="hljs-keyword">this</span>.dragging = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.clickPos = <span class="hljs-keyword">this</span>.mouseToSphere(x, y);
    <span class="hljs-keyword">this</span>.clickRot.copy(<span class="hljs-keyword">this</span>.currRot);
    <span class="hljs-keyword">this</span>.updateCamera();
    <span class="hljs-keyword">if</span> (shift) {
      <span class="hljs-keyword">this</span>.clickPosWindow.set(x, y);
      target = <span class="hljs-keyword">this</span>.camera.getTarget();
      <span class="hljs-keyword">this</span>.clickTarget = target.dup();
      targetInViewSpace = target.dup().transformMat4(<span class="hljs-keyword">this</span>.camera.getViewMatrix());
      <span class="hljs-keyword">this</span>.panPlane = <span class="hljs-keyword">new</span> Plane(targetInViewSpace, <span class="hljs-keyword">new</span> Vec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>));
      <span class="hljs-keyword">this</span>.clickPosPlane = <span class="hljs-keyword">this</span>.panPlane.intersectRay(<span class="hljs-keyword">this</span>.camera.getViewRay(<span class="hljs-keyword">this</span>.clickPosWindow.x, <span class="hljs-keyword">this</span>.clickPosWindow.y, <span class="hljs-keyword">this</span>.window.width, <span class="hljs-keyword">this</span>.window.height));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dragPosPlane = <span class="hljs-keyword">this</span>.panPlane.intersectRay(<span class="hljs-keyword">this</span>.camera.getViewRay(<span class="hljs-keyword">this</span>.dragPosWindow.x, <span class="hljs-keyword">this</span>.dragPosWindow.y, <span class="hljs-keyword">this</span>.window.width, <span class="hljs-keyword">this</span>.window.height));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.panPlane = <span class="hljs-literal">null</span>;
    }
  };

  Arcball.prototype.up = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, shift)</span> </span>{
    <span class="hljs-keyword">this</span>.dragging = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.panPlane = <span class="hljs-literal">null</span>;
  };

  Arcball.prototype.drag = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, shift)</span> </span>{
    <span class="hljs-keyword">var</span> invViewMatrix, theta;
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.dragging) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (shift &amp;&amp; <span class="hljs-keyword">this</span>.panPlane) {
      <span class="hljs-keyword">this</span>.dragPosWindow.set(x, y);
      <span class="hljs-keyword">this</span>.clickPosPlane = <span class="hljs-keyword">this</span>.panPlane.intersectRay(<span class="hljs-keyword">this</span>.camera.getViewRay(<span class="hljs-keyword">this</span>.clickPosWindow.x, <span class="hljs-keyword">this</span>.clickPosWindow.y, <span class="hljs-keyword">this</span>.window.width, <span class="hljs-keyword">this</span>.window.height));
      <span class="hljs-keyword">this</span>.dragPosPlane = <span class="hljs-keyword">this</span>.panPlane.intersectRay(<span class="hljs-keyword">this</span>.camera.getViewRay(<span class="hljs-keyword">this</span>.dragPosWindow.x, <span class="hljs-keyword">this</span>.dragPosWindow.y, <span class="hljs-keyword">this</span>.window.width, <span class="hljs-keyword">this</span>.window.height));
      invViewMatrix = <span class="hljs-keyword">this</span>.camera.getViewMatrix().dup().invert();
      <span class="hljs-keyword">this</span>.clickPosWorld = <span class="hljs-keyword">this</span>.clickPosPlane.dup().transformMat4(invViewMatrix);
      <span class="hljs-keyword">this</span>.dragPosWorld = <span class="hljs-keyword">this</span>.dragPosPlane.dup().transformMat4(invViewMatrix);
      <span class="hljs-keyword">this</span>.diffWorld = <span class="hljs-keyword">this</span>.dragPosWorld.dup().sub(<span class="hljs-keyword">this</span>.clickPosWorld);
      <span class="hljs-keyword">this</span>.camera.setTarget(<span class="hljs-keyword">this</span>.clickTarget.dup().sub(<span class="hljs-keyword">this</span>.diffWorld));
      <span class="hljs-keyword">this</span>.updateCamera();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.dragPos = <span class="hljs-keyword">this</span>.mouseToSphere(x, y);
      <span class="hljs-keyword">this</span>.rotAxis.asCross(<span class="hljs-keyword">this</span>.clickPos, <span class="hljs-keyword">this</span>.dragPos);
      theta = <span class="hljs-keyword">this</span>.clickPos.dot(<span class="hljs-keyword">this</span>.dragPos);
      <span class="hljs-keyword">this</span>.dragRot.set(<span class="hljs-keyword">this</span>.rotAxis.x, <span class="hljs-keyword">this</span>.rotAxis.y, <span class="hljs-keyword">this</span>.rotAxis.z, theta);
      <span class="hljs-keyword">this</span>.currRot.asMul(<span class="hljs-keyword">this</span>.dragRot, <span class="hljs-keyword">this</span>.clickRot);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateCamera();
  };

  Arcball.prototype.updateCamera = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> eye, offset, q, target, up;
    q = <span class="hljs-keyword">this</span>.currRot.clone();
    q.w *= -<span class="hljs-number">1</span>;
    target = <span class="hljs-keyword">this</span>.camera.getTarget();
    offset = Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.distance).transformQuat(q);
    eye = Vec3.create().asAdd(target, offset);
    up = Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>).transformQuat(q);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.camera.lookAt(target, eye, up);
  };

  Arcball.prototype.disableZoom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.allowZooming = <span class="hljs-literal">false</span>;
  };

  Arcball.prototype.setDistance = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(distance)</span> </span>{
    <span class="hljs-keyword">this</span>.distance = distance || <span class="hljs-number">2</span>;
    <span class="hljs-keyword">this</span>.minDistance = distance / <span class="hljs-number">2</span> || <span class="hljs-number">0.3</span>;
    <span class="hljs-keyword">this</span>.maxDistance = distance * <span class="hljs-number">2</span> || <span class="hljs-number">5</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateCamera();
  };

  <span class="hljs-keyword">return</span> Arcball;

})();

<span class="hljs-built_in">module</span>.exports = Arcball;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

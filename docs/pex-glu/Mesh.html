<!DOCTYPE html>

<html>
<head>
  <title>Mesh.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Mesh.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Generated by CoffeeScript 1.7.1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> BoundingBox, Context, Mat4, Mesh, Quat, RenderableGeometry, Vec3, merge, _ref;

merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'merge'</span>);

_ref = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pex-geom'</span>), Vec3 = _ref.Vec3, Quat = _ref.Quat, Mat4 = _ref.Mat4, BoundingBox = _ref.BoundingBox;

Context = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Context'</span>);

RenderableGeometry = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./RenderableGeometry'</span>);

Mesh = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Mesh</span><span class="hljs-params">(geometry, material, options)</span> </span>{
    <span class="hljs-keyword">this</span>.gl = Context.currentContext;
    <span class="hljs-keyword">this</span>.geometry = merge(geometry, RenderableGeometry);
    <span class="hljs-keyword">this</span>.material = material;
    options = options || {};
    <span class="hljs-keyword">this</span>.primitiveType = options.primitiveType;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.primitiveType == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">this</span>.primitiveType = <span class="hljs-keyword">this</span>.gl.TRIANGLES;
    }
    <span class="hljs-keyword">if</span> (options.lines) {
      <span class="hljs-keyword">this</span>.primitiveType = <span class="hljs-keyword">this</span>.gl.LINES;
    }
    <span class="hljs-keyword">if</span> (options.triangles) {
      <span class="hljs-keyword">this</span>.primitiveType = <span class="hljs-keyword">this</span>.gl.TRIANGLES;
    }
    <span class="hljs-keyword">if</span> (options.points) {
      <span class="hljs-keyword">this</span>.primitiveType = <span class="hljs-keyword">this</span>.gl.POINTS;
    }
    <span class="hljs-keyword">this</span>.position = Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>.rotation = Quat.create();
    <span class="hljs-keyword">this</span>.scale = Vec3.create(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">this</span>.projectionMatrix = Mat4.create();
    <span class="hljs-keyword">this</span>.viewMatrix = Mat4.create();
    <span class="hljs-keyword">this</span>.invViewMatrix = Mat4.create();
    <span class="hljs-keyword">this</span>.modelWorldMatrix = Mat4.create();
    <span class="hljs-keyword">this</span>.modelViewMatrix = Mat4.create();
    <span class="hljs-keyword">this</span>.rotationMatrix = Mat4.create();
    <span class="hljs-keyword">this</span>.normalMatrix = Mat4.create();
  }

  Mesh.prototype.draw = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(camera)</span> </span>{
    <span class="hljs-keyword">var</span> num;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.geometry.isDirty()) {
      <span class="hljs-keyword">this</span>.geometry.compile();
    }
    <span class="hljs-keyword">if</span> (camera) {
      <span class="hljs-keyword">this</span>.updateMatrices(camera);
      <span class="hljs-keyword">this</span>.updateMatricesUniforms(<span class="hljs-keyword">this</span>.material);
    }
    <span class="hljs-keyword">this</span>.material.use();
    <span class="hljs-keyword">this</span>.bindAttribs();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.geometry.faces &amp;&amp; <span class="hljs-keyword">this</span>.geometry.faces.length &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.primitiveType !== <span class="hljs-keyword">this</span>.gl.LINES &amp;&amp; <span class="hljs-keyword">this</span>.primitiveType !== <span class="hljs-keyword">this</span>.gl.POINTS) {
      <span class="hljs-keyword">this</span>.gl.bindBuffer(<span class="hljs-keyword">this</span>.gl.ELEMENT_ARRAY_BUFFER, <span class="hljs-keyword">this</span>.geometry.faces.buffer.handle);
      <span class="hljs-keyword">this</span>.gl.drawElements(<span class="hljs-keyword">this</span>.primitiveType, <span class="hljs-keyword">this</span>.geometry.faces.buffer.dataBuf.length, <span class="hljs-keyword">this</span>.gl.UNSIGNED_SHORT, <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.geometry.edges &amp;&amp; <span class="hljs-keyword">this</span>.geometry.edges.length &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.primitiveType === <span class="hljs-keyword">this</span>.gl.LINES) {
      <span class="hljs-keyword">this</span>.gl.bindBuffer(<span class="hljs-keyword">this</span>.gl.ELEMENT_ARRAY_BUFFER, <span class="hljs-keyword">this</span>.geometry.edges.buffer.handle);
      <span class="hljs-keyword">this</span>.gl.drawElements(<span class="hljs-keyword">this</span>.primitiveType, <span class="hljs-keyword">this</span>.geometry.edges.buffer.dataBuf.length, <span class="hljs-keyword">this</span>.gl.UNSIGNED_SHORT, <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.geometry.vertices) {
      num = <span class="hljs-keyword">this</span>.geometry.vertices.length;
      <span class="hljs-keyword">this</span>.gl.drawArrays(<span class="hljs-keyword">this</span>.primitiveType, <span class="hljs-number">0</span>, num);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unbindAttribs();
  };

  Mesh.prototype.drawInstances = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(camera, instances)</span> </span>{
    <span class="hljs-keyword">var</span> instance, num, _i, _j, _k, _len, _len1, _len2;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.geometry.isDirty()) {
      <span class="hljs-keyword">this</span>.geometry.compile();
    }
    <span class="hljs-keyword">this</span>.material.use();
    <span class="hljs-keyword">this</span>.bindAttribs();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.geometry.faces &amp;&amp; <span class="hljs-keyword">this</span>.geometry.faces.length &gt; <span class="hljs-number">0</span> &amp;&amp; !<span class="hljs-keyword">this</span>.useEdges) {
      <span class="hljs-keyword">this</span>.gl.bindBuffer(<span class="hljs-keyword">this</span>.gl.ELEMENT_ARRAY_BUFFER, <span class="hljs-keyword">this</span>.geometry.faces.buffer.handle);
      <span class="hljs-keyword">for</span> (_i = <span class="hljs-number">0</span>, _len = instances.length; _i &lt; _len; _i++) {
        instance = instances[_i];
        <span class="hljs-keyword">if</span> (camera) {
          <span class="hljs-keyword">this</span>.updateMatrices(camera, instance);
          <span class="hljs-keyword">this</span>.updateMatricesUniforms(<span class="hljs-keyword">this</span>.material);
          <span class="hljs-keyword">this</span>.updateUniforms(<span class="hljs-keyword">this</span>.material, instance);
          <span class="hljs-keyword">this</span>.material.use();
        }
        <span class="hljs-keyword">this</span>.gl.drawElements(<span class="hljs-keyword">this</span>.primitiveType, <span class="hljs-keyword">this</span>.geometry.faces.buffer.dataBuf.length, <span class="hljs-keyword">this</span>.gl.UNSIGNED_SHORT, <span class="hljs-number">0</span>);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.geometry.edges &amp;&amp; <span class="hljs-keyword">this</span>.useEdges) {
      <span class="hljs-keyword">this</span>.gl.bindBuffer(<span class="hljs-keyword">this</span>.gl.ELEMENT_ARRAY_BUFFER, <span class="hljs-keyword">this</span>.geometry.edges.buffer.handle);
      <span class="hljs-keyword">for</span> (_j = <span class="hljs-number">0</span>, _len1 = instances.length; _j &lt; _len1; _j++) {
        instance = instances[_j];
        <span class="hljs-keyword">if</span> (camera) {
          <span class="hljs-keyword">this</span>.updateMatrices(camera, instance);
          <span class="hljs-keyword">this</span>.updateMatricesUniforms(<span class="hljs-keyword">this</span>.material);
          <span class="hljs-keyword">this</span>.updateUniforms(<span class="hljs-keyword">this</span>.material, instance);
          <span class="hljs-keyword">this</span>.material.use();
        }
        <span class="hljs-keyword">this</span>.gl.drawElements(<span class="hljs-keyword">this</span>.primitiveType, <span class="hljs-keyword">this</span>.geometry.edges.buffer.dataBuf.length, <span class="hljs-keyword">this</span>.gl.UNSIGNED_SHORT, <span class="hljs-number">0</span>);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.geometry.vertices) {
      num = <span class="hljs-keyword">this</span>.geometry.vertices.length;
      <span class="hljs-keyword">for</span> (_k = <span class="hljs-number">0</span>, _len2 = instances.length; _k &lt; _len2; _k++) {
        instance = instances[_k];
        <span class="hljs-keyword">if</span> (camera) {
          <span class="hljs-keyword">this</span>.updateMatrices(camera, instance);
          <span class="hljs-keyword">this</span>.updateMatricesUniforms(<span class="hljs-keyword">this</span>.material);
          <span class="hljs-keyword">this</span>.updateUniforms(<span class="hljs-keyword">this</span>.material, instance);
          <span class="hljs-keyword">this</span>.material.use();
        }
        <span class="hljs-keyword">this</span>.gl.drawArrays(<span class="hljs-keyword">this</span>.primitiveType, <span class="hljs-number">0</span>, num);
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unbindAttribs();
  };

  Mesh.prototype.bindAttribs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> attrib, name, program, _ref1, _results;
    program = <span class="hljs-keyword">this</span>.material.program;
    _ref1 = <span class="hljs-keyword">this</span>.geometry.attribs;
    _results = [];
    <span class="hljs-keyword">for</span> (name <span class="hljs-keyword">in</span> _ref1) {
      attrib = _ref1[name];
      attrib.location = <span class="hljs-keyword">this</span>.gl.getAttribLocation(program.handle, attrib.name);
      <span class="hljs-keyword">if</span> (attrib.location &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.gl.bindBuffer(<span class="hljs-keyword">this</span>.gl.ARRAY_BUFFER, attrib.buffer.handle);
        <span class="hljs-keyword">this</span>.gl.vertexAttribPointer(attrib.location, attrib.buffer.elementSize, <span class="hljs-keyword">this</span>.gl.FLOAT, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        _results.push(<span class="hljs-keyword">this</span>.gl.enableVertexAttribArray(attrib.location));
      } <span class="hljs-keyword">else</span> {
        _results.push(<span class="hljs-keyword">void</span> <span class="hljs-number">0</span>);
      }
    }
    <span class="hljs-keyword">return</span> _results;
  };

  Mesh.prototype.unbindAttribs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> attrib, name, _ref1, _results;
    _ref1 = <span class="hljs-keyword">this</span>.geometry.attribs;
    _results = [];
    <span class="hljs-keyword">for</span> (name <span class="hljs-keyword">in</span> _ref1) {
      attrib = _ref1[name];
      <span class="hljs-keyword">if</span> (attrib.location &gt;= <span class="hljs-number">0</span>) {
        _results.push(<span class="hljs-keyword">this</span>.gl.disableVertexAttribArray(attrib.location));
      } <span class="hljs-keyword">else</span> {
        _results.push(<span class="hljs-keyword">void</span> <span class="hljs-number">0</span>);
      }
    }
    <span class="hljs-keyword">return</span> _results;
  };

  Mesh.prototype.resetAttribLocations = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> attrib, name, _results;
    _results = [];
    <span class="hljs-keyword">for</span> (name <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.attributes) {
      attrib = <span class="hljs-keyword">this</span>.attributes[name];
      _results.push(attrib.location = -<span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">return</span> _results;
  };

  Mesh.prototype.updateMatrices = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(camera, instance)</span> </span>{
    <span class="hljs-keyword">var</span> position, rotation, scale;
    position = instance &amp;&amp; instance.position ? instance.position : <span class="hljs-keyword">this</span>.position;
    rotation = instance &amp;&amp; instance.rotation ? instance.rotation : <span class="hljs-keyword">this</span>.rotation;
    scale = instance &amp;&amp; instance.scale ? instance.scale : <span class="hljs-keyword">this</span>.scale;
    rotation.toMat4(<span class="hljs-keyword">this</span>.rotationMatrix);
    <span class="hljs-keyword">this</span>.modelWorldMatrix.identity().translate(position.x, position.y, position.z).mul(<span class="hljs-keyword">this</span>.rotationMatrix).scale(scale.x, scale.y, scale.z);
    <span class="hljs-keyword">if</span> (camera) {
      <span class="hljs-keyword">this</span>.projectionMatrix.copy(camera.getProjectionMatrix());
      <span class="hljs-keyword">this</span>.viewMatrix.copy(camera.getViewMatrix());
      <span class="hljs-keyword">this</span>.invViewMatrix.copy(camera.getViewMatrix().dup().invert());
      <span class="hljs-keyword">this</span>.modelViewMatrix.copy(camera.getViewMatrix()).mul(<span class="hljs-keyword">this</span>.modelWorldMatrix);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.normalMatrix.copy(<span class="hljs-keyword">this</span>.modelViewMatrix).invert().transpose();
    }
  };

  Mesh.prototype.updateUniforms = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(material, instance)</span> </span>{
    <span class="hljs-keyword">var</span> uniformName, uniformValue, _ref1, _results;
    _ref1 = instance.uniforms;
    _results = [];
    <span class="hljs-keyword">for</span> (uniformName <span class="hljs-keyword">in</span> _ref1) {
      uniformValue = _ref1[uniformName];
      _results.push(material.uniforms[uniformName] = uniformValue);
    }
    <span class="hljs-keyword">return</span> _results;
  };

  Mesh.prototype.updateMatricesUniforms = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(material)</span> </span>{
    <span class="hljs-keyword">var</span> materialUniforms, programUniforms;
    programUniforms = <span class="hljs-keyword">this</span>.material.program.uniforms;
    materialUniforms = <span class="hljs-keyword">this</span>.material.uniforms;
    <span class="hljs-keyword">if</span> (programUniforms.projectionMatrix) {
      materialUniforms.projectionMatrix = <span class="hljs-keyword">this</span>.projectionMatrix;
    }
    <span class="hljs-keyword">if</span> (programUniforms.viewMatrix) {
      materialUniforms.viewMatrix = <span class="hljs-keyword">this</span>.viewMatrix;
    }
    <span class="hljs-keyword">if</span> (programUniforms.invViewMatrix) {
      materialUniforms.invViewMatrix = <span class="hljs-keyword">this</span>.invViewMatrix;
    }
    <span class="hljs-keyword">if</span> (programUniforms.modelWorldMatrix) {
      materialUniforms.modelWorldMatrix = <span class="hljs-keyword">this</span>.modelWorldMatrix;
    }
    <span class="hljs-keyword">if</span> (programUniforms.modelViewMatrix) {
      materialUniforms.modelViewMatrix = <span class="hljs-keyword">this</span>.modelViewMatrix;
    }
    <span class="hljs-keyword">if</span> (programUniforms.normalMatrix) {
      <span class="hljs-keyword">return</span> materialUniforms.normalMatrix = <span class="hljs-keyword">this</span>.normalMatrix;
    }
  };

  Mesh.prototype.getMaterial = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.material;
  };

  Mesh.prototype.setMaterial = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(material)</span> </span>{
    <span class="hljs-keyword">this</span>.material = material;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.resetAttribLocations();
  };

  Mesh.prototype.getProgram = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.material.program;
  };

  Mesh.prototype.setProgram = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(program)</span> </span>{
    <span class="hljs-keyword">this</span>.material.program = program;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.resetAttribLocations();
  };

  Mesh.prototype.dispose = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.geometry.dispose();
  };

  Mesh.prototype.getBoundingBox = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.boundingBox) {
      <span class="hljs-keyword">this</span>.updateBoundingBox();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.boundingBox;
  };

  Mesh.prototype.updateBoundingBox = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.updateMatrices();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.boundingBox = BoundingBox.fromPoints(<span class="hljs-keyword">this</span>.geometry.vertices.map((<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_this)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> </span>{
        <span class="hljs-keyword">return</span> v.dup().transformMat4(_this.modelWorldMatrix);
      };
    })(<span class="hljs-keyword">this</span>)));
  };

  <span class="hljs-keyword">return</span> Mesh;

})();

<span class="hljs-built_in">module</span>.exports = Mesh;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

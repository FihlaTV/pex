<!DOCTYPE html>

<html>
<head>
  <title>Quat.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Quat.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Mat4 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Mat4'</span>);
<span class="hljs-keyword">var</span> Vec3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Vec3'</span>);
<span class="hljs-keyword">var</span> kEpsilon = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, -<span class="hljs-number">24</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Quat</span><span class="hljs-params">(x, y, z, w)</span> </span>{
  <span class="hljs-keyword">this</span>.x = x != <span class="hljs-literal">null</span> ? x : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">this</span>.y = y != <span class="hljs-literal">null</span> ? y : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">this</span>.z = z != <span class="hljs-literal">null</span> ? z : <span class="hljs-number">0</span>;
  <span class="hljs-keyword">this</span>.w = w != <span class="hljs-literal">null</span> ? w : <span class="hljs-number">1</span>;
}

Quat.create = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z, w)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Quat(x, y, z, w);
};

Quat.fromArray = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Quat(a[<span class="hljs-number">0</span>], a[<span class="hljs-number">1</span>], a[<span class="hljs-number">2</span>], a[<span class="hljs-number">3</span>]);
}

Quat.prototype.identity = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.set(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.equals = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(q, tolerance)</span> </span>{
  <span class="hljs-keyword">if</span> (tolerance == <span class="hljs-literal">null</span>) {
    tolerance = <span class="hljs-number">0.0000001</span>;
  }
  <span class="hljs-keyword">return</span> (<span class="hljs-built_in">Math</span>.abs(q.x - <span class="hljs-keyword">this</span>.x) &lt;= tolerance) &amp;&amp; (<span class="hljs-built_in">Math</span>.abs(q.y - <span class="hljs-keyword">this</span>.y) &lt;= tolerance) &amp;&amp; (<span class="hljs-built_in">Math</span>.abs(q.z - <span class="hljs-keyword">this</span>.z) &lt;= tolerance) &amp;&amp; (<span class="hljs-built_in">Math</span>.abs(q.w - <span class="hljs-keyword">this</span>.w) &lt;= tolerance);
};

Quat.prototype.hash = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> * <span class="hljs-keyword">this</span>.x + <span class="hljs-number">12</span> * <span class="hljs-keyword">this</span>.y + <span class="hljs-number">123</span> * <span class="hljs-keyword">this</span>.z + <span class="hljs-number">1234</span> * <span class="hljs-keyword">this</span>.w;
};

Quat.prototype.copy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(q)</span> </span>{
  <span class="hljs-keyword">this</span>.x = q.x;
  <span class="hljs-keyword">this</span>.y = q.y;
  <span class="hljs-keyword">this</span>.z = q.z;
  <span class="hljs-keyword">this</span>.w = q.w;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.clone = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Quat(<span class="hljs-keyword">this</span>.x, <span class="hljs-keyword">this</span>.y, <span class="hljs-keyword">this</span>.z, <span class="hljs-keyword">this</span>.w);
};

Quat.prototype.dup = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.clone();
};

Quat.prototype.setAxisAngle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, a)</span> </span>{
  a = a * <span class="hljs-number">0.5</span>;
  <span class="hljs-keyword">var</span> s = <span class="hljs-built_in">Math</span>.sin(a / <span class="hljs-number">180</span> * <span class="hljs-built_in">Math</span>.PI);
  <span class="hljs-keyword">this</span>.x = s * v.x;
  <span class="hljs-keyword">this</span>.y = s * v.y;
  <span class="hljs-keyword">this</span>.z = s * v.z;
  <span class="hljs-keyword">this</span>.w = <span class="hljs-built_in">Math</span>.cos(a / <span class="hljs-number">180</span> * <span class="hljs-built_in">Math</span>.PI);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.setQuat = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(q)</span> </span>{
  <span class="hljs-keyword">this</span>.x = q.x;
  <span class="hljs-keyword">this</span>.y = q.y;
  <span class="hljs-keyword">this</span>.z = q.z;
  <span class="hljs-keyword">this</span>.w = q.w;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z, w)</span> </span>{
  <span class="hljs-keyword">this</span>.x = x;
  <span class="hljs-keyword">this</span>.y = y;
  <span class="hljs-keyword">this</span>.z = z;
  <span class="hljs-keyword">this</span>.w = w;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.asMul = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p, q)</span> </span>{
  <span class="hljs-keyword">var</span> px = p.x;
  <span class="hljs-keyword">var</span> py = p.y;
  <span class="hljs-keyword">var</span> pz = p.z;
  <span class="hljs-keyword">var</span> pw = p.w;
  <span class="hljs-keyword">var</span> qx = q.x;
  <span class="hljs-keyword">var</span> qy = q.y;
  <span class="hljs-keyword">var</span> qz = q.z;
  <span class="hljs-keyword">var</span> qw = q.w;
  <span class="hljs-keyword">this</span>.x = px * qw + pw * qx + py * qz - pz * qy;
  <span class="hljs-keyword">this</span>.y = py * qw + pw * qy + pz * qx - px * qz;
  <span class="hljs-keyword">this</span>.z = pz * qw + pw * qz + px * qy - py * qx;
  <span class="hljs-keyword">this</span>.w = pw * qw - px * qx - py * qy - pz * qz;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.mul = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(q)</span> </span>{
  <span class="hljs-keyword">this</span>.asMul(<span class="hljs-keyword">this</span>, q);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.mul4 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, z, w)</span> </span>{
  <span class="hljs-keyword">var</span> ax = <span class="hljs-keyword">this</span>.x;
  <span class="hljs-keyword">var</span> ay = <span class="hljs-keyword">this</span>.y;
  <span class="hljs-keyword">var</span> az = <span class="hljs-keyword">this</span>.z;
  <span class="hljs-keyword">var</span> aw = <span class="hljs-keyword">this</span>.w;
  <span class="hljs-keyword">this</span>.x = w * ax + x * aw + y * az - z * ay;
  <span class="hljs-keyword">this</span>.y = w * ay + y * aw + z * ax - x * az;
  <span class="hljs-keyword">this</span>.z = w * az + z * aw + x * ay - y * ax;
  <span class="hljs-keyword">this</span>.w = w * aw - x * ax - y * ay - z * az;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.length = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-keyword">this</span>.x * <span class="hljs-keyword">this</span>.x + <span class="hljs-keyword">this</span>.y * <span class="hljs-keyword">this</span>.y + <span class="hljs-keyword">this</span>.z * <span class="hljs-keyword">this</span>.z + <span class="hljs-keyword">this</span>.w * <span class="hljs-keyword">this</span>.w);
};

Quat.prototype.normalize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> len = <span class="hljs-keyword">this</span>.length();
  <span class="hljs-keyword">if</span> (len &gt; kEpsilon) {
    <span class="hljs-keyword">this</span>.x /= len;
    <span class="hljs-keyword">this</span>.y /= len;
    <span class="hljs-keyword">this</span>.z /= len;
    <span class="hljs-keyword">this</span>.w /= len;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Quat.prototype.toMat4 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(out)</span> </span>{
  <span class="hljs-keyword">var</span> xs = <span class="hljs-keyword">this</span>.x + <span class="hljs-keyword">this</span>.x;
  <span class="hljs-keyword">var</span> ys = <span class="hljs-keyword">this</span>.y + <span class="hljs-keyword">this</span>.y;
  <span class="hljs-keyword">var</span> zs = <span class="hljs-keyword">this</span>.z + <span class="hljs-keyword">this</span>.z;
  <span class="hljs-keyword">var</span> wx = <span class="hljs-keyword">this</span>.w * xs;
  <span class="hljs-keyword">var</span> wy = <span class="hljs-keyword">this</span>.w * ys;
  <span class="hljs-keyword">var</span> wz = <span class="hljs-keyword">this</span>.w * zs;
  <span class="hljs-keyword">var</span> xx = <span class="hljs-keyword">this</span>.x * xs;
  <span class="hljs-keyword">var</span> xy = <span class="hljs-keyword">this</span>.x * ys;
  <span class="hljs-keyword">var</span> xz = <span class="hljs-keyword">this</span>.x * zs;
  <span class="hljs-keyword">var</span> yy = <span class="hljs-keyword">this</span>.y * ys;
  <span class="hljs-keyword">var</span> yz = <span class="hljs-keyword">this</span>.y * zs;
  <span class="hljs-keyword">var</span> zz = <span class="hljs-keyword">this</span>.z * zs;
  <span class="hljs-keyword">var</span> m = out || <span class="hljs-keyword">new</span> Mat4();
  <span class="hljs-keyword">return</span> m.set4x4r(<span class="hljs-number">1</span> - (yy + zz), xy - wz, xz + wy, <span class="hljs-number">0</span>, xy + wz, <span class="hljs-number">1</span> - (xx + zz), yz - wx, <span class="hljs-number">0</span>, xz - wy, yz + wx, <span class="hljs-number">1</span> - (xx + yy), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
};

Quat.prototype.setDirection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(direction, debug)</span> </span>{
  <span class="hljs-keyword">var</span> dir = Vec3.create().copy(direction).normalize();

  <span class="hljs-keyword">var</span> up = Vec3.create(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">var</span> right = Vec3.create().asCross(up, dir);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>if debug then console.log(‘right’, right)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">if</span> (right.length() == <span class="hljs-number">0</span>) {
    up.set(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    right.asCross(up, dir);
  }

  up.asCross(dir, right);
  right.normalize();
  up.normalize();

  <span class="hljs-keyword">if</span> (debug) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'dir'</span>, dir);
  <span class="hljs-keyword">if</span> (debug) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'up'</span>, up);
  <span class="hljs-keyword">if</span> (debug) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'right'</span>, right);

  <span class="hljs-keyword">var</span> m = <span class="hljs-keyword">new</span> Mat4();
  m.set4x4r(
    right.x, right.y, right.z, <span class="hljs-number">0</span>,
    up.x, up.y, up.z, <span class="hljs-number">0</span>,
    dir.x, dir.y, dir.z, <span class="hljs-number">0</span>,
    <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>
  );</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Step 3. Build a quaternion from the matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> q = <span class="hljs-keyword">new</span> Quat()
  <span class="hljs-keyword">if</span> (<span class="hljs-number">1.0</span> + m.a11 + m.a22 + m.a33 &lt; <span class="hljs-number">0.001</span>) {
    <span class="hljs-keyword">if</span> (debug) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'singularity'</span>);
    dir = direction.dup();
    dir.z *= -<span class="hljs-number">1</span>;
    dir.normalize();
    up.set(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
    right.asCross(up, dir);
    up.asCross(dir, right);
    right.normalize();
    up.normalize();
    m = <span class="hljs-keyword">new</span> Mat4();
    m.set4x4r(
      right.x, right.y, right.z, <span class="hljs-number">0</span>,
      up.x, up.y, up.z, <span class="hljs-number">0</span>,
      dir.x, dir.y, dir.z, <span class="hljs-number">0</span>,
      <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>
    );
    q.w = <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">1.0</span> + m.a11 + m.a22 + m.a33) / <span class="hljs-number">2.0</span>;
    <span class="hljs-keyword">var</span> dfWScale = q.w * <span class="hljs-number">4.0</span>;
    q.x = ((m.a23 - m.a32) / dfWScale);
    q.y = ((m.a31 - m.a13) / dfWScale);
    q.z = ((m.a12 - m.a21) / dfWScale);
    <span class="hljs-keyword">if</span> (debug) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'dir'</span>, dir);
    <span class="hljs-keyword">if</span> (debug) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'up'</span>, up);
    <span class="hljs-keyword">if</span> (debug) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'right'</span>, right);

    q2 = <span class="hljs-keyword">new</span> Quat();
    q2.setAxisAngle(<span class="hljs-keyword">new</span> Vec3(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>), <span class="hljs-number">180</span>)
    q2.mul(q);
    <span class="hljs-keyword">this</span>.copy(q2);
    <span class="hljs-keyword">return</span>;
  }
  q.w = <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">1.0</span> + m.a11 + m.a22 + m.a33) / <span class="hljs-number">2.0</span>;
  dfWScale = q.w * <span class="hljs-number">4.0</span>;
  q.x = ((m.a23 - m.a32) / dfWScale);
  q.y = ((m.a31 - m.a13) / dfWScale);
  q.z = ((m.a12 - m.a21) / dfWScale);

  <span class="hljs-keyword">this</span>.copy(q);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
}

Quat.prototype.slerp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(qb, t)</span> </span>{
  <span class="hljs-keyword">var</span> qa = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Calculate angle between the quaternions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> cosHalfTheta = qa.w * qb.w + qa.x * qb.x + qa.y * qb.y + qa.z * qb.z;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If qa=qb or qa=-qb then theta = 0 and we can return qa</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(cosHalfTheta) &gt;= <span class="hljs-number">1.0</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">var</span> halfTheta = <span class="hljs-built_in">Math</span>.acos(cosHalfTheta);
  <span class="hljs-keyword">var</span> sinHalfTheta = <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">1.0</span> - cosHalfTheta*cosHalfTheta);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If theta = 180 degrees then result is not fully defined
we could rotate around any axis normal to qa or qb</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(sinHalfTheta) &lt; <span class="hljs-number">0.001</span>){ <span class="hljs-comment">// fabs is floating point absolute</span>
    <span class="hljs-keyword">this</span>.w = (qa.w * <span class="hljs-number">0.5</span> + qb.w * <span class="hljs-number">0.5</span>);
    <span class="hljs-keyword">this</span>.x = (qa.x * <span class="hljs-number">0.5</span> + qb.x * <span class="hljs-number">0.5</span>);
    <span class="hljs-keyword">this</span>.y = (qa.y * <span class="hljs-number">0.5</span> + qb.y * <span class="hljs-number">0.5</span>);
    <span class="hljs-keyword">this</span>.z = (qa.z * <span class="hljs-number">0.5</span> + qb.z * <span class="hljs-number">0.5</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }

  <span class="hljs-keyword">var</span> ratioA = <span class="hljs-built_in">Math</span>.sin((<span class="hljs-number">1</span> - t) * halfTheta) / sinHalfTheta;
  <span class="hljs-keyword">var</span> ratioB = <span class="hljs-built_in">Math</span>.sin(t * halfTheta) / sinHalfTheta;

  <span class="hljs-keyword">this</span>.w = (qa.w * ratioA + qb.w * ratioB);
  <span class="hljs-keyword">this</span>.x = (qa.x * ratioA + qb.x * ratioB);
  <span class="hljs-keyword">this</span>.y = (qa.y * ratioA + qb.y * ratioB);
  <span class="hljs-keyword">this</span>.z = (qa.z * ratioA + qb.z * ratioB);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
}

Quat.fromAxisAngle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, a)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Quat().setAxisAngle(v, a);
}

Quat.fromDirection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(direction)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Quat().setDirection(direction);
}


<span class="hljs-built_in">module</span>.exports = Quat;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

<!DOCTYPE html>

<html>
<head>
  <title>FXStage.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>FXStage.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> glu = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pex-glu'</span>);
<span class="hljs-keyword">var</span> Context = glu.Context;
<span class="hljs-keyword">var</span> ScreenImage = glu.ScreenImage;
<span class="hljs-keyword">var</span> RenderTarget = glu.RenderTarget;
<span class="hljs-keyword">var</span> Program = glu.Program;
<span class="hljs-keyword">var</span> Texture2D = glu.Texture2D;
<span class="hljs-keyword">var</span> FXResourceMgr = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./FXResourceMgr'</span>);

<span class="hljs-keyword">var</span> FXStageCount = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">FXStage</span><span class="hljs-params">(source, resourceMgr, fullscreenQuad)</span> </span>{
  <span class="hljs-keyword">this</span>.id = FXStageCount++;
  <span class="hljs-keyword">this</span>.gl = Context.currentContext;
  <span class="hljs-keyword">this</span>.source = source || <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.resourceMgr = resourceMgr || <span class="hljs-keyword">new</span> FXResourceMgr();
  <span class="hljs-keyword">this</span>.fullscreenQuad = fullscreenQuad || <span class="hljs-keyword">new</span> ScreenImage();
  <span class="hljs-keyword">this</span>.defaultBPP = <span class="hljs-number">8</span>;
}

FXStage.prototype.reset = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">this</span>.resourceMgr.markAllAsNotUsed();
};

FXStage.prototype.getOutputSize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(width, height, verbose)</span> </span>{
  <span class="hljs-keyword">if</span> (width &amp;&amp; height) {
    <span class="hljs-keyword">return</span> {
      width: width,
      height: height
    };
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.source) {
    <span class="hljs-keyword">return</span> {
      width: <span class="hljs-keyword">this</span>.source.width,
      height: <span class="hljs-keyword">this</span>.source.height
    };
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> viewport = <span class="hljs-keyword">this</span>.gl.getParameter(<span class="hljs-keyword">this</span>.gl.VIEWPORT);
    <span class="hljs-keyword">return</span> {
      width: viewport[<span class="hljs-number">2</span>],
      height: viewport[<span class="hljs-number">3</span>]
    };
  }
};

FXStage.prototype.getRenderTarget = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, h, depth, bpp)</span> </span>{
  depth = depth || <span class="hljs-literal">false</span>;
  bpp = bpp || <span class="hljs-keyword">this</span>.defaultBPP;
  <span class="hljs-keyword">var</span> resProps = {
    w: w,
    h: h,
    depth: depth,
    bpp: bpp
  };
  <span class="hljs-keyword">var</span> res = <span class="hljs-keyword">this</span>.resourceMgr.getResource(<span class="hljs-string">'RenderTarget'</span>, resProps);
  <span class="hljs-keyword">if</span> (!res) {
    <span class="hljs-keyword">var</span> renderTarget = <span class="hljs-keyword">new</span> RenderTarget(w, h, resProps);
    res = <span class="hljs-keyword">this</span>.resourceMgr.addResource(<span class="hljs-string">'RenderTarget'</span>, renderTarget, resProps);
  }
  res.used = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> res.obj;
};

FXStage.prototype.getFXStage = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
  <span class="hljs-keyword">var</span> resProps = {};
  <span class="hljs-keyword">var</span> res = <span class="hljs-keyword">this</span>.resourceMgr.getResource(<span class="hljs-string">'FXStage'</span>, resProps);
  <span class="hljs-keyword">if</span> (!res) {
    <span class="hljs-keyword">var</span> fxState = <span class="hljs-keyword">new</span> FXStage(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>.resourceMgr, <span class="hljs-keyword">this</span>.fullscreenQuad);
    res = <span class="hljs-keyword">this</span>.resourceMgr.addResource(<span class="hljs-string">'FXStage'</span>, fxState, resProps);
  }
  res.used = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> res.obj;
};

FXStage.prototype.asFXStage = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(source, name)</span> </span>{
  <span class="hljs-keyword">var</span> stage = <span class="hljs-keyword">this</span>.getFXStage(name);
  stage.source = source;
  stage.name = name + <span class="hljs-string">'_'</span> + stage.id;
  <span class="hljs-keyword">return</span> stage;
};

FXStage.prototype.getShader = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(code)</span> </span>{
  <span class="hljs-keyword">if</span> (code.indexOf(<span class="hljs-string">'.glsl'</span>) == code.length - <span class="hljs-number">5</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'FXStage.getShader - loading files not supported yet.'</span>;
  }
  <span class="hljs-keyword">var</span> resProps = { code: code };
  <span class="hljs-keyword">var</span> res = <span class="hljs-keyword">this</span>.resourceMgr.getResource(<span class="hljs-string">'Program'</span>, resProps);
  <span class="hljs-keyword">if</span> (!res) {
    <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(code);
    res = <span class="hljs-keyword">this</span>.resourceMgr.addResource(<span class="hljs-string">'Program'</span>, program, resProps);
  }
  res.used = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> res.obj;
};

FXStage.prototype.getSourceTexture = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(source)</span> </span>{
  <span class="hljs-keyword">if</span> (source) {
    <span class="hljs-keyword">if</span> (source.source) {
      <span class="hljs-keyword">if</span> (source.source.getColorAttachment) {
        <span class="hljs-keyword">return</span> source.source.getColorAttachment(<span class="hljs-number">0</span>);
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> source.source;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source.getColorAttachment) {
      <span class="hljs-keyword">return</span> source.getColorAttachment(<span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> source;
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.source) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.source.getColorAttachment) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.source.getColorAttachment(<span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.source;
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-string">'FXStage.getSourceTexture() No source texture!'</span>;
};

FXStage.prototype.drawFullScreenQuad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(width, height, image, program)</span> </span>{
  <span class="hljs-keyword">this</span>.drawFullScreenQuadAt(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height, image, program);
};

FXStage.prototype.drawFullScreenQuadAt = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x, y, width, height, image, program)</span> </span>{
  <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.gl;
  gl.disable(gl.DEPTH_TEST);
  <span class="hljs-keyword">var</span> oldViewport = gl.getParameter(gl.VIEWPORT);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>false disables scissor test just in case</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  glu.viewport(x, y, width, height, <span class="hljs-literal">false</span>);
  <span class="hljs-keyword">this</span>.fullscreenQuad.draw(image, program);
  glu.viewport(oldViewport[<span class="hljs-number">0</span>], oldViewport[<span class="hljs-number">1</span>], oldViewport[<span class="hljs-number">2</span>], oldViewport[<span class="hljs-number">3</span>], <span class="hljs-literal">false</span>);
};

FXStage.prototype.getImage = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">var</span> resProps = { path: path };
  <span class="hljs-keyword">var</span> res = <span class="hljs-keyword">this</span>.resourceMgr.getResource(<span class="hljs-string">'Image'</span>, resProps);
  <span class="hljs-keyword">if</span> (!res) {
    <span class="hljs-keyword">var</span> image = Texture2D.load(path);
    res = <span class="hljs-keyword">this</span>.resourceMgr.addResource(<span class="hljs-string">'Image'</span>, image, resProps);
  }
  res.used = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>can be shared so no need for locking</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> res.obj;
};

FXStage.prototype.getFullScreenQuad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fullscreenQuad;
};

<span class="hljs-built_in">module</span>.exports = FXStage;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
